{% extends "base.html" %} {% block main %}
<!-- <div class="container mt-5">
  <div class="card shadow rounded bg-dark mt-5">
    <div class="card-body text-center">
      <h5 class="card-title" style="color: white; font-size: 72px">Databank</h5>
    </div>
  </div>
</div>
<div class="container mt-5" style="margin-bottom: -20px">
  <div class="card shadow rounded mt-5" style="background-color: #137a63">
    <div class="card-body text-center">
      <h5 class="card-title" style="color: white; font-size: 48px">Device</h5>
    </div>
  </div>
</div> -->
<dib class="screen">
  <div class="to-center">
    <div class="card card-show device">
      <div class="card-header position-relative">
        <div class="show-title">Device</div>
        <a href="javascript:void(0)" onclick="openAddModal()">
          <img
            src="{{ url_for('static', filename='icon/plus-icon.png' ) }}"
            alt="Uploaded Image"
            class="icon-header"
          />
        </a>
        <a href="javascript:void(0)" onclick="showDelete()">
          <img
            src="{{ url_for('static', filename='icon/delete-icon.png' ) }}"
            alt="Uploaded Image"
            class="icon-header-left delete-icon-show"
          />
        </a>
        <a href="javascript:void(0)" onclick="closeDelete()">
          <img
            src="{{ url_for('static', filename='icon/x-icon.png' ) }}"
            alt="Uploaded Image"
            class="icon-header-left x-icon-show d-none"
          />
        </a>
      </div>
        <div class="card-body">
          {% if not session.get("devices") %}
            <div class="text-center">You have 0 device.</div>
          {% else %}
            <div class="data-content">
              {# loop device key show in table#}
              {% if session.get("devices") %}
                {% for device_id in session.get("devices").keys() %}
                  
                  <div class="card card-width card-item">
                    <div class="card-body body-height position-relative">
                      <div class="text-margin-top">Device Name: {{ session.get("devices")[device_id] ["device_name"] }}</div>
                      <div>Device Type: {{ session.get("devices")[device_id] ["device_type"] }}</div>
                      <div>
                        Unprocessed Data:
                        {% for un_data in  session.get("devices")[device_id]["device_unprocessed"][:-1] %}
                          {{ un_data }},
                        {% endfor %}
                        {{ session.get("devices")[device_id] ["device_unprocessed"] [-1] }}
                      </div>
                      <img
                        src="{{ url_for('static', filename='icon/edit-icon.png' ) }}"
                        alt="edit icon"
                        class="edit-icon"
                        onclick='showEditModal("{{device_id}}","{{session.get("devices")[device_id]}}")'
                      />
                      <a href="javascript:void(0)" onclick="closeAlert('{{device_id}}')">
                        <div class="box-animation">
                          <img
                            src="{{ url_for('static', filename='icon/delete-icon.png' ) }}"
                            alt="edit icon"
                            class="delete-icon d-none"
                          />
                        </div>
                      </a>
                    </div>
                  </div>
                {% endfor %}
              {% endif %}
            </div>
          {% endif %}
      </div>
    </div>
  </div>
</dib>

<div class="container mt-5">
  <!-- Devices-->
  <!-- <div id="device_part">
    {% include "page_sections/device_section.html" ignore missing %}
  </div> -->
</div>

<!-- Modal -->
<div
  class="modal fade device-modal"
  id="addModal"
  tabindex="-1"
  aria-labelledby="exampleModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header position-relative">
        <h5 class="modal-title">Add Device</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <form id="device_form">
          <div class="row">
            <div class="col-md-12">
              <label for="device_name" class="d-flex"
                ><div class="text-label">Device Name</div>
                <span class="text-danger">*</span></label
              >
              <input
                type="text"
                class="form-control"
                id="device_name"
                placeholder="Enter device name"
                required
              />
            </div>
            <div class="d-none text-danger" id="same_name">this device name is already exist.</div>
            <div class="col-md-12 mt-1">
              <label for="device_type" class="d-flex"
                ><div class="text-label">Device Type</div>
                <span class="text-danger">*</span></label
              >
              <div class="select2-select">
                <select id="device_type" onchange="deviceTypeOther()" name="deviceType" class="form-control">
                  <!-- <option value="" selected disabled>Device Type</option> -->
                  {% for (index , _type_device) in
                  form_utils["device"]["type_device"]%}
                  <option value="{{ _type_device }}">{{ _type_device }}</option>
                  {% endfor %}
                  <option value="other">Other</option>
                </select>
                <div class="d-none col-12 mb-2 mt-2 d-flex" id="device_type_other_input">
                  <input
                    id="device_input_device_type"
                    type="text"
                    class="form-control me-2"
                    placeholder="Enter your device type"
                  />
                  <button type="button" class="btn btn-add" onclick="addNewType()" id="addOptionButton">
                    Add
                  </button>
                </div>
                <div class="d-none text-danger" id="type_duplicate">New device type is duplicate.</div>
              </div>
            </div>
            <div class="col-md-12 mt-1"></div>
              <label for="unprocessed_data" class="d-flex"
                ><div class="text-label">Unprocessed Data</div>
                <span class="text-danger">*</span></label
              >
              <div class="show-unprocess-data">
                <!-- <span class="badge badge-device mb-2">
                  <input type="hidden" name="unprocessData[]" id="unprocess_data_{}">
                  <span class="text-show">Color</span>
                  <button type="button" class="btn-close btn-close-white" aria-label="Close"></button>
                </span>
                <span class="badge badge-device mb-2">
                  <input type="hidden" name="unprocessData[]" id="unprocess_data_{}">
                  <span class="text-show">Temperature</span>
                  <button type="button" class="btn-close btn-close-white" aria-label="Close"></button>
                </span> -->
              </div>
              <div class="select2-select mt-2 me-2 d-flex">
                <select id="unprocessed_data" onchange="unprocessedDataOther()" class="form-control">
                  <!-- <option value="" selected disabled>Unprocessed Data</option> -->
                  {% for (index , _unprocessed_data) in
                  form_utils["device"]["unprocessed_data"]%}
                  <option value="{{ _unprocessed_data }}">
                    {{ _unprocessed_data }}
                  </option>
                  {% endfor %}
                  <option value="other">Other</option>
                </select>
                <button type="button" onclick="showAddUnprocessedData()" class="btn btn-device ms-2">
                  Add
                </button>
              </div>
              <div class="d-none col-12 mb-3 mt-2 d-flex" id="device_unprocessed_other_input">
                <input
                  id="device_input_unprocessed"
                  type="text"
                  class="form-control me-2"
                  placeholder="Enter your unprocessed data"
                />
                <button type="button" class="btn btn-add" onclick="addNewUnprocessedData()" id="device_upprocessed_data_add_button">
                  Add
                </button>
              </div>
              <div class="d-none text-danger" id="data_duplicate">New device unprocessed type is duplicate.</div>
              <div class="text-danger d-none" id="no_data">no unprocessed data</div>
              <div class="text-center mt-2">
                <button type="button" id="modal_add_btn" onclick="validation()" class="btn btn-add ms-2">
                  Add device
                </button>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock main %} {% block js %}
<script>
  $("#device_type").select2({
    width: "100%",
    dropdownParent: $("#addModal"),
  });
  $("#unprocessed_data").select2({
    width: "100%",
    dropdownParent: $("#addModal"),
  });
  function openAddModal() {
    $("#addModal").modal("show");
    $('#device_name').val('');
    let firstOptionValue = $('#device_type option:first').val();
    $('#device_type').val(firstOptionValue).trigger('change');
    firstOptionValue = $('#unprocessed_data option:first').val();
    $('#unprocessed_data').val(firstOptionValue).trigger('change');
    $('.show-unprocess-data').empty();
    $('.modal-title')[0].innerHTML = "Add Device";
    $('#modal_add_btn')[0].innerHTML = "Add Device";
    $('#modal_add_btn').attr('onclick','validation()');
    resetInvalid();
  }
  function resetInvalid(){
    $('#device_name').removeClass('is-invalid')
    $('#device_input_device_type').removeClass('is-invalid');
    $('#device_type').parent().find('span').removeClass('is-invalid');
    $('#device_input_unprocessed').removeClass('is-invalid');
    $('#no_data').addClass('d-none');
    $('#unprocessed_data').parent().find('span').removeClass('is-invalid');
    $('#same_name').addClass('d-none');
  }
  function showAddUnprocessedData(){
    let id = $("#unprocessed_data").val();
    if($('#unprocessed_data_'+id.replaceAll(" ","_")).length==0){
      $('.show-unprocess-data').append(`
        <span class="badge badge-device mb-2" id="unprocessed_data_${id.replaceAll(" ","_")}">
          <input type="hidden" name="unprocessData[]" value="${id}">
          <span class="text-show">${id}</span>
          <button type="button" onclick="deleteUnprocessedData(this)" class="btn-close btn-close-white" aria-label="Close"></button>
        </span>
      `)
    }
  }
  function deleteUnprocessedData(e){
    $(e).parent().remove();
  }
  async function validation(type = "add",id = "add"){
    var valid = true;
    if($('#device_name').val()){
      $('#device_name').removeClass('is-invalid')
    }else{
      valid = false;
      $('#device_name').addClass('is-invalid')
    }
    if($('#device_type').val()== "other"){
      valid = false;
      $('#device_type').parent().find('span').addClass('is-invalid');
      if($('#device_input_device_type').val()){
        $('#device_input_device_type').removeClass('is-invalid');
      }else{
        valid = false;
        $('#device_input_device_type').addClass('is-invalid');
      }
    }else{
      $('#device_type').parent().find('span').removeClass('is-invalid');
    }
    if($('#unprocessed_data').val() == "other"){
      valid=false
      $('#unprocessed_data').parent().find('span').addClass('is-invalid');
      if($('#device_input_unprocessed').val()){
        $('#device_input_unprocessed').removeClass('is-invalid');
      }else{
        valid = false;
        $('#device_input_unprocessed').addClass('is-invalid');
      }
    }else{
      $('#unprocessed_data').parent().find('span').removeClass('is-invalid');
      if($('input[name="unprocessData[]"]').length>0){
        $('#no_data').addClass('d-none');
        $('#unprocessed_data').parent().find('span').removeClass('is-invalid');
      }else{
        valid = false;
        $('#no_data').removeClass('d-none');
        $('#unprocessed_data').parent().find('span').addClass('is-invalid');
      }
    }
    let session_all = await $.ajax({
            url: "/session/get",
            type: "get",
            dataType: "json",
            contentType: "application/json",
    })
    let device_data = [];
    $('input[name="unprocessData[]"]').each((index,data)=>{
      device_data.push($(data).val());
    })
    device = {
      device_name:$('#device_name').val(),
      device_type:$('#device_type').val(),
      device_unprocessed: device_data,
      new_device: true
    }
    if(type == 'edit'){
      var device_name = [];
      for (_device_id in session_all["devices"]) {
        if (_device_id !== "{{form_utils['device_id']}}" && _device_id != id) {
          device_name.push(
            session_all["devices"][_device_id]["device_name"]
          );
        }
      }
      if (device_name.includes(device["device_name"])) {
        valid = false;
        $('#same_name').removeClass('d-none');
      }else{
        $('#same_name').addClass('d-none');
      }
    }else{
      var device_name = [];
      for (_device_id in session_all["devices"]) {
        device_name.push(session_all["devices"][_device_id]["device_name"]);
      }
      if (device_name.includes(device["device_name"])) {
        valid = false;
        $('#same_name').removeClass('d-none');
      }else{
        $('#same_name').addClass('d-none');
      }
    }
    if(valid){
      Swal.fire({
        title: "Are you sure?",
        text: "You won't be able to revert this!",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#4B8B4C",
        cancelButtonColor: "#B41A1A",
        confirmButtonText: "Confirm",
      }).then((result) => {
        if (result.isConfirmed) {
          if(type == 'edit'){
            device.new_device = false;
            $.ajax({
              url: "/device/update/"+id,
              type: "post",
              dataType: "json",
              contentType: "application/json",
              success: function () {
                window.location.href = "/device/device_page";
              },
              data: JSON.stringify(device),
            });
          }else{
            device.new_device = true;
            $.ajax({
              url: "/device/add",
              type: "post",
              dataType: "json",
              contentType: "application/json",
              success: function () {
                window.location.href = "/device/device_page";
              },
              data: JSON.stringify(device),
            });
          }
        }
      });
    }
  }
  function deviceTypeOther(){
    if($('#device_type').val()=="other"){
      $('#device_type_other_input').removeClass('d-none');
    }else{
      $('#device_type_other_input').addClass('d-none');
    }
  }
  function unprocessedDataOther(){
    if($('#unprocessed_data').val()=="other"){
      $('#device_unprocessed_other_input').removeClass('d-none');
    }else{
      $('#device_unprocessed_other_input').addClass('d-none');
    }
  }
  function checkDuplicate(selectId,data) {
    let select = document.getElementById(selectId);
    let optionValues = [];
    let hasDuplicates = false;

    for (let i = 0; i < select.options.length; i++) {
      let value = select.options[i].value;
      if (value.toUpperCase() == data.toUpperCase()) {
        hasDuplicates = true;
      } else {
        optionValues.push(value);
      }
    }

    return hasDuplicates;
  }
  function addNewType(){
    if($('#device_type').val() == "other"){
      let data = $('#device_input_device_type').val();
      let isDuplicate = checkDuplicate('device_type',data);
      if(isDuplicate){
        $('#type_duplicate').removeClass('d-none');
        $('#device_input_device_type').addClass('is-invalid');
      }else{
        $('#type_duplicate').addClass('d-none');
        $('#device_input_device_type').removeClass('is-invalid');
        if(data){
          $('#device_input_device_type').removeClass('is-invalid');
          $('#device_type').prepend(`<option value="${data}">${data}</option>`);
          $('#device_type').val(data).toggle('change');
          $('#device_input_device_type').val('');
          $('#device_type_other_input').addClass('d-none')
        }else{
          $('#device_input_device_type').addClass('is-invalid');
        }
      }
    }
  }
  function addNewUnprocessedData(){
    if($('#unprocessed_data').val() == "other"){
      let data = $('#device_input_unprocessed').val();
      let isDuplicate = checkDuplicate('unprocessed_data',data);
      if(isDuplicate){
        $('#data_duplicate').removeClass('d-none');
        $('#device_input_unprocessed').addClass('is-invalid');
      }else{
        $('#data_duplicate').addClass('d-none');
        $('#device_input_unprocessed').removeClass('is-invalid');
        if(data){
          $('#device_input_unprocessed').removeClass('is-invalid');
          $('#unprocessed_data').prepend(`<option value="${data}">${data}</option>`);
          $('#unprocessed_data').val(data).toggle('change');
          $('#device_input_unprocessed').val('');
          $('#device_unprocessed_other_input').addClass('d-none')
        }else{
          $('#device_input_unprocessed').addClass('is-invalid');
        }
      }
    }
  }
  function showDelete(){
    $('.box-animation').addClass('box-animation-forward');
    $('.box-animation').removeClass('box-animation-reverse');
    $('.box-animation img').removeClass('d-none');
    $('.delete-icon-show').addClass('d-none');
    $('.x-icon-show').removeClass('d-none');
  }
  function closeDelete(){
    $('.box-animation').addClass('box-animation-reverse');
    $('.box-animation').removeClass('box-animation-forward');
    $('.box-animation img').addClass('d-none');
    $('.delete-icon-show').removeClass('d-none');
    $('.x-icon-show').addClass('d-none');
  }
  function closeAlert(id){
    Swal.fire({
        title: "Are you sure?",
        text: "You won't be able to revert this!",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#4B8B4C",
        cancelButtonColor: "#B41A1A",
        confirmButtonText: "Confirm",
      }).then((result) => {
        if (result.isConfirmed) {
          window.location.href = "/device/delete/"+id;
        }
      })
  }
  function showEditModal(id,data){
    let device = JSON.parse(data.replaceAll("'",'"'));
    $("#addModal").modal("show");
    $('#device_name').val(device['device_name']);
    $('#device_type').val(device['device_type']).trigger('change');
    firstOptionValue = $('#unprocessed_data option:first').val();
    $('#unprocessed_data').val(firstOptionValue).trigger('change');
    $('.show-unprocess-data').empty();
    device['device_unprocessed'].forEach((doc,key)=>{
      $('.show-unprocess-data').append(`
        <span class="badge badge-device mb-2" id="unprocessed_data_${doc.replaceAll(" ","_")}">
          <input type="hidden" name="unprocessData[]" value="${doc}">
          <span class="text-show">${doc}</span>
          <button type="button" onclick="deleteUnprocessedData(this)" class="btn-close btn-close-white" aria-label="Close"></button>
        </span>
      `);
    })
    $('.modal-title')[0].innerHTML = "Edit Device";
    $('#modal_add_btn')[0].innerHTML = "Edit Device";
    $('#modal_add_btn').attr('onclick','validation("edit",'+id+')');
    resetInvalid();
  }
</script>
{% endblock js %} {% block css %}
<style>
  /* animation */
  .box-animation{
    width: 0vw;
    height: 100%;
    background-color: var(--delete-color);
    position: absolute;
    top: 0%;
    right: 0%; 
    border-top-left-radius: 10px;
  }
  .box-animation-reverse{
      animation: expandWidthReverse 0.5s ease-in-out 1 forwards;
  }
  .box-animation-forward{
      animation: expandWidth 0.5s ease-in-out 1 forwards;
  }
  @keyframes expandWidth {
      0% {
          width: 0%; 
      }
      100% {
          width: 7%; 
      }
  }
  @keyframes expandWidthReverse {
      0% {
          width: 7%; 
      }
      100% {
          width: 0%; 
      }
  }
  
  /* end animation */
  .device .icon-header-left{
    position: absolute;
    left:3%;
    top:50%;
    transform: translateY(-50%);
  }
  /* button-add */
  .btn-add:hover{
    background-color:var(--add-color);
    border-color:var(--add-color);
    color:white;
  }
  .btn-add{
    background-color:var(--add-color);
    border-color:var(--add-color);
    color:white;
  }
  /* button-device */
  .btn-device{
    background-color:var(--device-color);
    border-color:var(--device-color);
    color:white;
  }
  .btn-device:hover{
    background-color:var(--device-color);
    border-color:var(--device-color);
    color:white;
  }

  .badge-device{
    font-size: 1.0vw;
    background-color:var(--device-color);
    border-color:var(--device-color);
    position: relative;
  }
  .badge-device .text-show{
    margin-right: 1vw;
    font-weight:500;
  }
  .badge-device button{
    width: 0.7vw !important;
    height: 0.7vw !important;;
    position:absolute;
    right: 5%;
    top: 50%;
    transform: translateY(-50%);
    padding-right: 0px !important;
  }
  .device-modal .modal-header {
    height: 4.17vw;
    font-size: 1.67vw;
    text-align: center;
    color: white;
  }
  .device-modal .modal-header {
    background-color: var(--device-color);
  }
  .service-modal .modal-header {
    background-color: var(--service-color);
  }
  .modal-title {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    font-size: 1.67vw;
  }
  .btn-close {
    width: 1.2vw !important;
    height: 1.4vw !important;
    filter: brightness(0) invert(1);
    opacity: 1 !important;
    padding: 0px 2vw 0px 0px !important;
  }

  /* height */
  .select2-container .select2-selection--single {
    height: 1.82vw; /* Set height */
  }
  .select2-container .select2-selection--single .select2-selection__rendered {
    line-height: 1.82vw; /* Align text vertically */
  }
  .select2-container .select2-selection--single .select2-selection__arrow {
    height: 1.82vw; /* Set height of the dropdown arrow */
  }

  .text-label {
    font-weight: 800;
  }
  .is-invalid .select2-selection,
  .needs-validation~span>.select2-dropdown {
      border-color: red !important;
  }

  /* body */
  /* .device .show-amount{
    text-align: center;
  } */
  .device .body-height{
    height: 4.8vw;
    width:100%;
    border-left: 1.21vw solid var(--device-color);
  }
  .device .card-width{
    width:90%;
  }
  .device .data-content{
    display: flex;
    justify-content: center;
    align-content: center;
    flex-wrap: wrap;
  }
  .device .card-item:not(:first-child){
    margin-top:-1px;
  }
  .device .text-margin-top{
    margin-top:-0.45vw;
  }
  .device .edit-icon{
    position:absolute;
    top:50%;
    right:3%;
    transform: translateY(-50%);
    cursor: pointer;
  }
  .device .delete-icon{
    position:absolute;
    top:50%;
    left:50%;
    transform: translate(-50%,-50%);
  }
</style>
{% include "css/card-header.html" ignore missing %} {% endblock css %}
